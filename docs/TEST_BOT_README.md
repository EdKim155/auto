# Тестер бота @ACarriers_bot

## Быстрый старт

**Самый простой способ запустить тестирование:**

```bash
python run_bot_test.py
```

Выберите нужный режим из меню и следуйте инструкциям.

---

## Описание

Скрипт `test_acarriers_bot.py` предназначен для автоматического тестирования взаимодействия с Telegram-ботом @ACarriers_bot. Он позволяет:

- Отправлять команды боту (например, `/start`)
- Автоматически нажимать кнопки из меню
- Отслеживать все ответы и изменения сообщений от бота
- Логировать все взаимодействия для последующего анализа
- Избегать нажатия кнопок "подтвердить" и других запрещенных действий

## Требования

Убедитесь, что установлены все зависимости:

```bash
pip install -r requirements.txt
```

## Настройка

Убедитесь, что в файле `.env` указаны правильные учетные данные:

```env
API_ID=27270483
API_HASH=054487666c6a886114b50b6210e8c051
PHONE=+79507380505
```

## Запуск

### Автоматический режим

Запустите скрипт для автоматического тестирования:

```bash
python test_acarriers_bot.py
```

Скрипт автоматически:
1. Подключится к Telegram
2. Отправит команду `/start` боту @ACarriers_bot
3. Нажмет на первую доступную кнопку (исключая запрещенные)
4. Попытается вернуться в главное меню
5. Выведет подробный отчет о всех взаимодействиях

### Интерактивный режим (РЕКОМЕНДУЕТСЯ)

Запустите интерактивную версию для полного контроля:

```bash
python test_acarriers_bot_interactive.py
```

Интерактивный режим предоставляет:
- Ручное управление через консольное меню
- Выбор кнопок для нажатия по номеру
- Отправку произвольных команд
- Просмотр истории сообщений
- Защиту от случайного нажатия запрещенных кнопок

#### Доступные команды в интерактивном режиме:

| Команда | Описание |
|---------|----------|
| `1-9` | Быстрое нажатие кнопки (1-9) |
| `b <номер>` | Нажать кнопку с любым номером (например, `b 15`) |
| `s` | Отправить команду /start |
| `c <команда>` | Отправить произвольную команду (например, `c /help`) |
| `l` | Показать все кнопки из последнего сообщения |
| `h` | Показать историю сообщений |
| `v` | Показать список нажатых кнопок |
| `sum` | Показать итоговую статистику |
| `help` | Показать справку |
| `q` | Выйти |

#### Пример интерактивной сессии:

```
> s                    # Отправить /start
> l                    # Посмотреть доступные кнопки
> 1                    # Нажать первую кнопку
> l                    # Посмотреть новые кнопки
> 2                    # Нажать вторую кнопку
> h                    # Посмотреть историю
> v                    # Посмотреть, что уже нажимали
> q                    # Выйти
```

### Логи

Все действия логируются в два места:
1. **Консоль** - вывод в реальном времени
2. **Файл лога**:
   - `test_acarriers_bot.log` - для автоматического режима
   - `test_acarriers_bot_interactive.log` - для интерактивного режима

## Что логируется

### Информация о сообщениях
- ID сообщения
- Время получения
- Тип (новое сообщение или редактирование)
- Текст сообщения
- Список всех кнопок с их позициями

### Информация о кнопках
Для каждой кнопки логируется:
- Текст кнопки
- Позиция (ряд, колонка)
- Тип (CALLBACK или URL)
- Статус (FORBIDDEN для запрещенных кнопок)

### Пример лога

```
2025-01-17 15:30:45 - INFO - ============================================================
2025-01-17 15:30:45 - INFO - NEW MESSAGE from bot (ID: 12345)
2025-01-17 15:30:45 - INFO - Time: 15:30:45.123
2025-01-17 15:30:45 - INFO - ============================================================
2025-01-17 15:30:45 - INFO - TEXT:
Добро пожаловать! Выберите действие:
2025-01-17 15:30:45 - INFO -
BUTTONS (3 total):
2025-01-17 15:30:45 - INFO -   [1] 'Список прямых перевозок' (Row: 0, Col: 0, Type: CALLBACK)
2025-01-17 15:30:45 - INFO -   [2] 'Мои заказы' (Row: 1, Col: 0, Type: CALLBACK)
2025-01-17 15:30:45 - INFO -   [3] 'Помощь' (Row: 2, Col: 0, Type: CALLBACK)
```

## Запрещенные кнопки

Скрипт автоматически пропускает кнопки, содержащие следующие ключевые слова:
- `подтвердить`
- `подтверд`
- `забронировать`
- `взять`
- `беру`

При попытке нажать такую кнопку, вы увидите предупреждение:
```
!!! FORBIDDEN BUTTON: 'Подтвердить заказ' - SKIPPING !!!
```

## Итоговый отчет

После завершения тестирования скрипт выводит подробный отчет:

```
============================================================
TEST SUMMARY
============================================================

Total interactions: 5
Visited buttons: 2

Clicked buttons:
  - Список прямых перевозок
  - Назад в меню

All interactions timeline:
1. 15:30:45.123 [NEW] Message ID: 12345
   Text: Добро пожаловать! Выберите действие:
   Buttons: 3
     - Список прямых перевозок
     - Мои заказы
     - Помощь
...
```

## Модификация скрипта

### Изменение запрещенных кнопок

Отредактируйте список `forbidden_keywords` в классе `BotTester`:

```python
self.forbidden_keywords = ['подтвердить', 'подтверд', 'забронировать', 'взять', 'беру']
```

### Изменение глубины исследования

В методе `explore_menu()` измените параметр `max_depth`:

```python
await self.explore_menu(max_depth=5)  # Изменить на нужное значение
```

### Добавление задержек

Измените время ожидания после действий:

```python
await asyncio.sleep(2)  # 2 секунды ожидания
```

## Интеграция с автоматизацией

Результаты тестирования помогут настроить основную автоматизацию в `bot_automation.py`:

1. **Определить правильные ключевые слова для кнопок** - используйте логи для точного определения текста кнопок
2. **Понять время отклика бота** - посмотрите на временные метки в логах
3. **Выявить паттерны редактирования сообщений** - проанализируйте, как часто бот редактирует сообщения
4. **Оптимизировать задержки** - установите оптимальные значения `DELAY_BETWEEN_CLICKS` и `STABILIZATION_THRESHOLD`

## Устранение проблем

### Ошибка "Session not found"
Удалите файл `test_session.session` и запустите снова.

### Бот не отвечает
Проверьте, что бот @ACarriers_bot активен и доступен.

### Ошибка подключения
Убедитесь, что:
- Интернет соединение стабильно
- API_ID и API_HASH корректны
- Номер телефона указан в международном формате (+79507380505)

## Дополнительные возможности

Вы можете расширить функционал скрипта:

1. **Добавить тестирование конкретных сценариев**
2. **Реализовать автоматический возврат в меню**
3. **Сохранять скриншоты взаимодействий**
4. **Создать отчеты в формате JSON/CSV**

## Полезные команды

```bash
# Запуск с перенаправлением вывода в файл
python test_acarriers_bot.py > test_output.txt 2>&1

# Просмотр логов в реальном времени
tail -f test_acarriers_bot.log

# Поиск по логам
grep "BUTTONS" test_acarriers_bot.log
```
