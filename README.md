# Telegram Bot Automation

Автоматизированная система для быстрого нажатия inline-кнопок в Telegram боте при появлении уведомления о новых перевозках.

## Описание

Система автоматически выполняет последовательность из трех кликов при получении триггерного сообщения:

1. Нажатие кнопки "Список прямых перевозок"
2. Нажатие первой кнопки в списке перевозок
3. Нажатие кнопки подтверждения

### Ключевые особенности

- **Обход защиты от автоматизации**: Система преодолевает защиту через частое редактирование сообщений (2-15 раз/сек)
- **Высокая скорость реакции**: < 50ms после стабилизации сообщения
- **Надежность**: Автоматический retry при ошибках, обработка всех типов ошибок Telegram API
- **Адаптивность**: Работает при различных частотах редактирования сообщений
- **Гибкая настройка**: Все параметры настраиваются через конфигурацию

## Архитектура

Система состоит из следующих модулей:

- **MessageMonitor** - мониторинг сообщений и их редактирований
- **ButtonAnalyzer** - анализ и извлечение inline-кнопок
- **StabilizationDetector** - определение момента стабилизации сообщений
- **ClickExecutor** - выполнение кликов с retry-логикой
- **StateMachine** - управление последовательностью действий
- **ButtonCache** - кэширование кнопок для быстрого доступа

## Требования

- Python 3.8+
- Telegram API credentials (API_ID, API_HASH)
- Аккаунт Telegram

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd auto
```

### 2. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 3. Получение Telegram API credentials

1. Перейдите на https://my.telegram.org/apps
2. Войдите в свой аккаунт Telegram
3. Создайте новое приложение
4. Скопируйте `api_id` и `api_hash`

### 4. Настройка конфигурации

Скопируйте файл `.env.example` в `.env`:

```bash
cp .env.example .env
```

Отредактируйте `.env` и укажите свои данные:

```env
# Telegram API credentials
API_ID=your_api_id_here
API_HASH=your_api_hash_here
PHONE=+1234567890

# Target bot username
BOT_USERNAME=@your_bot_username

# Optional: Session name
SESSION_NAME=telegram_bot_automation
```

## Использование

### Запуск

```bash
python main.py
```

При первом запуске Telegram попросит вас ввести код подтверждения, отправленный на ваш номер телефона.

### Остановка

Нажмите `Ctrl+C` для остановки программы.

## Конфигурация

Все параметры настраиваются в файле `config.py`:

### Основные параметры

```python
# Триггерное сообщение
TRIGGER_TEXT = 'Появились новые перевозки'

# Задержки
DELAY_AFTER_TRIGGER = 0.05      # 50ms после обнаружения триггера
DELAY_BETWEEN_CLICKS = 0.1      # 100ms между кликами
STABILIZATION_THRESHOLD = 0.15  # 150ms порог стабилизации

# Стратегия стабилизации
STABILIZATION_STRATEGY = 'wait'  # 'wait', 'predict', 'aggressive'

# Retry
MAX_RETRIES = 3                 # Максимум попыток
RETRY_DELAY = 0.1               # 100ms между попытками
```

### Ключевые слова для поиска кнопок

```python
# Шаг 1: Список перевозок
BUTTON_1_KEYWORDS = [
    'список прямых перевозок',
    'список перевозок',
    'прямые перевозки'
]

# Шаг 2: Первая кнопка в списке (автоматически)
BUTTON_2_KEYWORDS = []

# Шаг 3: Подтверждение
BUTTON_3_KEYWORDS = [
    'подтвердить',
    'забронировать',
    'взять',
    'беру',
    'подтверждаю'
]
```

### Таймауты

```python
STEP_1_TIMEOUT = 5.0  # Максимум 5 секунд на шаг 1
STEP_2_TIMEOUT = 5.0  # Максимум 5 секунд на шаг 2
STEP_3_TIMEOUT = 5.0  # Максимум 5 секунд на шаг 3
```

## Стратегии стабилизации

Система поддерживает три стратегии определения момента стабилизации сообщения:

### 1. Wait (Рекомендуется)

```python
STABILIZATION_STRATEGY = 'wait'
```

- Ожидает прекращения редактирования перед нажатием
- Высокая надежность, минимум ошибок
- Небольшая задержка 100-200ms

### 2. Predict

```python
STABILIZATION_STRATEGY = 'predict'
```

- Анализирует паттерны редактирования
- Предсказывает финальное состояние
- Выигрыш времени при высокой конкуренции

### 3. Aggressive

```python
STABILIZATION_STRATEGY = 'aggressive'
```

- Минимальный порог стабилизации
- Максимальная скорость реакции
- Повышенный риск ошибок

## Логирование

Логи сохраняются в файл `bot_automation.log` и выводятся в консоль.

Уровень логирования настраивается через переменную окружения:

```env
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
```

## Статистика

Программа периодически выводит статистику:

```
=== AUTOMATION STATUS ===
Running: Yes

State Machine:
  current_state: IDLE
  total_runs: 10
  successful_runs: 9
  failed_runs: 1
  success_rate: 90.0%

Message Monitor:
  total_messages: 156
  total_edits: 847
  triggers_detected: 10

Click Executor:
  total_clicks: 27
  successful_clicks: 26
  failed_clicks: 1
  success_rate: 96.3%
```

## Производительность

- **Время реакции на стабилизацию**: < 50ms
- **Общее время выполнения**: < 500ms с момента стабилизации
- **Успешность выполнения**: > 95% при отсутствии конкуренции

## Обработка ошибок

Система автоматически обрабатывает следующие ошибки:

- `MESSAGE_NOT_MODIFIED` - сообщение изменилось во время клика
- `QUERY_ID_INVALID` - callback query устарел
- `FLOOD_WAIT` - превышен лимит запросов
- `TIMEOUT` - превышено время ожидания

Для каждой ошибки реализована retry-логика с экспоненциальной задержкой.

## Структура проекта

```
auto/
├── main.py                     # Точка входа
├── config.py                   # Конфигурация
├── bot_automation.py           # Главный класс автоматизации
├── modules/
│   ├── __init__.py
│   ├── message_monitor.py      # Мониторинг сообщений
│   ├── button_analyzer.py      # Анализ кнопок
│   ├── stabilization_detector.py  # Определение стабилизации
│   ├── click_executor.py       # Выполнение кликов
│   ├── state_machine.py        # Управление состоянием
│   └── button_cache.py         # Кэширование кнопок
├── requirements.txt            # Зависимости
├── .env.example               # Пример конфигурации
├── .gitignore
└── README.md
```

## Безопасность

- Храните `.env` файл в секрете и не коммитьте его в git
- Используйте только для личных целей
- Соблюдайте rate limits Telegram API
- Не используйте для массового бронирования

## Устранение неполадок

### Ошибка "User not authorized"

Удалите файл сессии и запустите программу снова:

```bash
rm telegram_bot_automation.session
python main.py
```

### Ошибка "Could not find bot"

Убедитесь, что:
1. Вы указали правильный username бота в `.env`
2. У вас есть активный чат с ботом
3. Бот не заблокирован

### Ошибка "FLOOD_WAIT"

Вы превысили лимит запросов Telegram API. Подождите указанное время или:
1. Увеличьте задержки в `config.py`
2. Уменьшите количество попыток

### Низкая успешность выполнения

Попробуйте:
1. Увеличить `STABILIZATION_THRESHOLD`
2. Изменить стратегию на `'wait'`
3. Увеличить `MAX_RETRIES`

## Техническая поддержка

Если у вас возникли проблемы:

1. Проверьте логи в `bot_automation.log`
2. Увеличьте уровень логирования до `DEBUG`
3. Убедитесь, что все зависимости установлены

## Лицензия

Этот проект предназначен только для личного использования.

## Отказ от ответственности

Автоматизация может нарушать условия использования некоторых ботов. Используйте на свой страх и риск.
