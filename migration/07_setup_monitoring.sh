#!/bin/bash

###############################################################################
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð¸ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¾Ð²
# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ logrotate, ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
###############################################################################

set -euo pipefail

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¸ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/config.sh"
source "$SCRIPT_DIR/utils.sh"

###############################################################################
# Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
###############################################################################

main() {
    log_step "ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“Ð Ð˜ Ð ÐžÐ¢ÐÐ¦Ð˜Ð˜ Ð›ÐžÐ“ÐžÐ’"

    init_migration

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¼Ñƒ ÑÐµÑ€Ð²ÐµÑ€Ñƒ
    log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¼Ñƒ ÑÐµÑ€Ð²ÐµÑ€Ñƒ..."
    check_ssh_connection "$TARGET_HOST" "$TARGET_USER" "" "$TARGET_ALIAS" || exit 1

    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° logrotate
    log_step "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° logrotate"

    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ logrotate..."

    local temp_logrotate="$TEMP_DIR/telegram-bot-logrotate"

    cat > "$temp_logrotate" << 'EOF'
/var/log/telegram-bot.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    sharedscripts
    postrotate
        systemctl reload telegram-bot.service >/dev/null 2>&1 || true
    endscript
}

/root/auto/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    maxsize 100M
}
EOF

    log_info "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ logrotate Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
    scp "$temp_logrotate" "$TARGET_USER@$TARGET_HOST:/tmp/telegram-bot"

    run_remote_command "$TARGET_HOST" "$TARGET_USER" "" \
        "mv /tmp/telegram-bot /etc/logrotate.d/telegram-bot && \
        chmod 644 /etc/logrotate.d/telegram-bot"

    log_success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ logrotate ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"

    # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ logrotate
    log_info "Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ logrotate..."
    run_remote_command "$TARGET_HOST" "$TARGET_USER" "" \
        "logrotate -d /etc/logrotate.d/telegram-bot" > "$TEMP_DIR/logrotate_test.log" 2>&1 || true

    log_success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ logrotate Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°"

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
    log_step "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°"

    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°..."

    local temp_healthcheck="$TEMP_DIR/healthcheck.sh"

    cat > "$temp_healthcheck" << 'HEALTHCHECK_EOF'
#!/bin/bash

###############################################################################
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Telegram-Ð±Ð¾Ñ‚Ð°
###############################################################################

SERVICE_NAME="telegram-bot.service"
LOG_FILE="/var/log/telegram-bot-healthcheck.log"
MAX_RESTART_ATTEMPTS=3

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°
if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    log_message "ERROR: Ð¡ÐµÑ€Ð²Ð¸Ñ $SERVICE_NAME Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð½ÐµÐ´Ð°Ð²Ð½Ð¸Ñ… Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
    restart_count=$(journalctl -u "$SERVICE_NAME" --since "5 minutes ago" | grep -c "Started" || echo 0)

    if [ "$restart_count" -lt "$MAX_RESTART_ATTEMPTS" ]; then
        log_message "INFO: ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°..."
        systemctl start "$SERVICE_NAME"

        sleep 5

        if systemctl is-active --quiet "$SERVICE_NAME"; then
            log_message "SUCCESS: Ð¡ÐµÑ€Ð²Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
        else
            log_message "ERROR: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸Ñ"
            # ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾)
            # curl -X POST "https://your-webhook-url" -d "Service $SERVICE_NAME failed"
        fi
    else
        log_message "ERROR: Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¾Ð² Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚ ($restart_count)"
        # ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
    fi
else
    log_message "INFO: Ð¡ÐµÑ€Ð²Ð¸Ñ $SERVICE_NAME Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾"

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°Ð¼ÑÑ‚Ð¸
    memory_usage=$(ps aux | grep "python.*main.py" | grep -v grep | awk '{print $4}' | head -1)
    log_message "INFO: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸: ${memory_usage}%"

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° CPU
    cpu_usage=$(ps aux | grep "python.*main.py" | grep -v grep | awk '{print $3}' | head -1)
    log_message "INFO: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ CPU: ${cpu_usage}%"

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð»Ð¾Ð³Ð°Ñ…
    error_count=$(tail -100 /var/log/telegram-bot.log | grep -ci "error" || echo 0)
    if [ "$error_count" -gt 10 ]; then
        log_message "WARN: ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ $error_count Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 100 ÑÑ‚Ñ€Ð¾ÐºÐ°Ñ… Ð»Ð¾Ð³Ð°"
    fi
fi
HEALTHCHECK_EOF

    chmod +x "$temp_healthcheck"

    log_info "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
    scp "$temp_healthcheck" "$TARGET_USER@$TARGET_HOST:$TARGET_APP_DIR/healthcheck.sh"

    run_remote_command "$TARGET_HOST" "$TARGET_USER" "" \
        "chmod +x $TARGET_APP_DIR/healthcheck.sh"

    log_success "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"

    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° cron Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
    log_step "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° cron Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°"

    log_info "Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² cron..."

    run_remote_command "$TARGET_HOST" "$TARGET_USER" "" \
        "(crontab -l 2>/dev/null | grep -v 'healthcheck.sh'; echo '*/5 * * * * $TARGET_APP_DIR/healthcheck.sh') | crontab -"

    log_success "Cron Ð·Ð°Ð´Ð°Ñ‡Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚)"

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
    log_step "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸"

    local temp_stats="$TEMP_DIR/bot_stats.sh"

    cat > "$temp_stats" << 'STATS_EOF'
#!/bin/bash

###############################################################################
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Telegram-Ð±Ð¾Ñ‚Ð°
###############################################################################

SERVICE_NAME="telegram-bot.service"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "            Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Telegram Bot Automation"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°:"
systemctl status "$SERVICE_NAME" --no-pager | head -10
echo ""

# Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
echo "â±ï¸  Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:"
systemctl show "$SERVICE_NAME" --property=ActiveEnterTimestamp --no-pager
echo ""

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
echo "ðŸ’» Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²:"
ps aux | grep "python.*main.py" | grep -v grep | awk '{printf "  CPU: %s%%\n  Memory: %s%%\n  PID: %s\n", $3, $4, $2}'
echo ""

# ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
echo "ðŸ“ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº Ð»Ð¾Ð³Ð°:"
tail -10 /var/log/telegram-bot.log
echo ""

# Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
echo "âš ï¸  Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 1000 ÑÑ‚Ñ€Ð¾Ðº):"
error_count=$(tail -1000 /var/log/telegram-bot.log | grep -ci "error" || echo 0)
warning_count=$(tail -1000 /var/log/telegram-bot.log | grep -ci "warning" || echo 0)
echo "  Errors: $error_count"
echo "  Warnings: $warning_count"
echo ""

# Ð Ð°Ð·Ð¼ÐµÑ€ Ð»Ð¾Ð³Ð¾Ð²
echo "ðŸ“‚ Ð Ð°Ð·Ð¼ÐµÑ€ Ð»Ð¾Ð³Ð¾Ð²:"
du -h /var/log/telegram-bot.log 2>/dev/null || echo "  Ð›Ð¾Ð³ Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
du -sh /root/auto/*.log 2>/dev/null || echo "  Ð›Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
echo ""

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸ÑÐºÐ°
echo "ðŸ’¾ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸ÑÐºÐ°:"
df -h / | tail -1
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
STATS_EOF

    chmod +x "$temp_stats"

    log_info "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
    scp "$temp_stats" "$TARGET_USER@$TARGET_HOST:$TARGET_APP_DIR/bot_stats.sh"

    run_remote_command "$TARGET_HOST" "$TARGET_USER" "" \
        "chmod +x $TARGET_APP_DIR/bot_stats.sh"

    log_success "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð»Ð¸Ð°ÑÐ¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
    log_step "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð»Ð¸Ð°ÑÐ¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°"

    log_info "Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð°Ð»Ð¸Ð°ÑÐ¾Ð² Ð² .bashrc..."

    run_remote_command "$TARGET_HOST" "$TARGET_USER" "" \
        "grep -q 'telegram-bot aliases' ~/.bashrc || cat >> ~/.bashrc << 'ALIASES_EOF'

# Telegram-bot aliases
alias bot-status='systemctl status telegram-bot.service'
alias bot-start='systemctl start telegram-bot.service'
alias bot-stop='systemctl stop telegram-bot.service'
alias bot-restart='systemctl restart telegram-bot.service'
alias bot-logs='journalctl -u telegram-bot.service -f'
alias bot-logs-tail='tail -f /var/log/telegram-bot.log'
alias bot-stats='$TARGET_APP_DIR/bot_stats.sh'
alias bot-health='$TARGET_APP_DIR/healthcheck.sh'
ALIASES_EOF
"

    log_success "ÐÐ»Ð¸Ð°ÑÑ‹ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð² .bashrc"

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ðµ
    log_step "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ðµ"

    local report_file="$BACKUP_DIR/monitoring_report_${TIMESTAMP}.md"

    cat > "$report_file" << EOF
# ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐµ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°

**Ð”Ð°Ñ‚Ð°:** $(date '+%Y-%m-%d %H:%M:%S')
**Ð¡ÐµÑ€Ð²ÐµÑ€:** $TARGET_HOST ($TARGET_ALIAS)

## Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð²

### ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ logrotate
- **Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:** /etc/logrotate.d/telegram-bot
- **Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ:** ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾
- **Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ:** 30 Ð´Ð½ÐµÐ¹ Ð´Ð»Ñ systemd Ð»Ð¾Ð³Ð¾Ð², 7 Ð´Ð½ÐµÐ¹ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
- **Ð¡Ð¶Ð°Ñ‚Ð¸Ðµ:** Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
- **ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€:** 100MB Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ

### Ð›Ð¾Ð³Ð¸
- /var/log/telegram-bot.log (Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³ systemd)
- /root/auto/*.log (Ð»Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)

## ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

### Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ healthcheck
- **Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:** $TARGET_APP_DIR/healthcheck.sh
- **Ð§Ð°ÑÑ‚Ð¾Ñ‚Ð°:** ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚ (cron)
- **Ð›Ð¾Ð³:** /var/log/telegram-bot-healthcheck.log
- **Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸:**
  - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°
  - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ðµ
  - ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
  - ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð»Ð¾Ð³Ð°Ñ…

### Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
- **Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:** $TARGET_APP_DIR/bot_stats.sh
- **Ð’Ñ‹Ð·Ð¾Ð²:** Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð°Ð»Ð¸Ð°Ñ \`bot-stats\`
- **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:**
  - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
  - Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
  - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ CPU Ð¸ Ð¿Ð°Ð¼ÑÑ‚Ð¸
  - ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
  - Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
  - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸ÑÐºÐ°

## ÐÐ»Ð¸Ð°ÑÑ‹ ÐºÐ¾Ð¼Ð°Ð½Ð´

Ð”Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð°Ð»Ð¸Ð°ÑÑ‹:

\`\`\`bash
bot-status      # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
bot-start       # Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
bot-stop        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°
bot-restart     # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
bot-logs        # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð² (journalctl)
bot-logs-tail   # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð² (tail)
bot-stats       # Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
bot-health      # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ
\`\`\`

## Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ

### ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
\`\`\`bash
ssh $TARGET_ALIAS 'bot-stats'
\`\`\`

### ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
\`\`\`bash
ssh $TARGET_ALIAS 'bot-logs'
\`\`\`

### Ð ÑƒÑ‡Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ
\`\`\`bash
ssh $TARGET_ALIAS 'bot-health'
\`\`\`

### ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð² healthcheck
\`\`\`bash
ssh $TARGET_ALIAS 'tail -f /var/log/telegram-bot-healthcheck.log'
\`\`\`

## ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ

- âœ… Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° (logrotate)
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ (cron ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚)
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ðµ
- âœ… ÐÐ»Ð¸Ð°ÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°

---
*ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°*
EOF

    log_success "ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ðµ ÑÐ¾Ð·Ð´Ð°Ð½: $report_file"

    log_step "ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“Ð Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ"
    log_success "ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"

    echo -e "\n${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "\n${GREEN}Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:${NC}"
    echo -e "  ${BLUE}ssh $TARGET_ALIAS 'bot-stats'${NC}      - ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°"
    echo -e "  ${BLUE}ssh $TARGET_ALIAS 'bot-logs'${NC}       - Ð»Ð¾Ð³Ð¸"
    echo -e "  ${BLUE}ssh $TARGET_ALIAS 'bot-health'${NC}     - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ"
    echo -e "\n${GREEN}ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚${NC}"
}

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
main "$@"
