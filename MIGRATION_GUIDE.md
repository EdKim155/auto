# Руководство по миграции Telegram-бота

## Обзор

Данное руководство описывает процесс миграции системы автоматизации Telegram-бота с исходного сервера на целевой сервер с использованием автоматизированных скриптов.

## Архитектура решения

Система миграции построена по принципу модульности и включает:

- **Автоматизация:** Скрипты для каждого этапа миграции
- **Безопасность:** Резервное копирование и проверка целостности
- **Мониторинг:** Автоматический контроль работы сервиса
- **Откат:** План восстановления в случае проблем

## Серверы

### Исходный сервер
- **IP:** 72.56.76.248
- **Алиас:** aprel-server
- **SSH:** `ssh -i ~/.ssh/id_ed25519_aprel root@72.56.76.248`
- **Директория:** /root/auto

### Целевой сервер
- **IP:** 193.108.115.170
- **Алиас:** auto-server
- **SSH:** `ssh auto-server`
- **Директория:** /root/auto

## Структура миграции

```
migration/
├── README.md                    # Документация
├── QUICKSTART.md               # Быстрый старт
├── config.sh                   # Конфигурация
├── utils.sh                    # Вспомогательные функции
├── migrate.sh                  # Главный скрипт
├── 01_audit_source.sh         # Аудит исходного сервера
├── 02_prepare_target.sh       # Подготовка целевого сервера
├── 03_backup_and_transfer.sh  # Резервное копирование и перенос
├── 04_setup_environment.sh    # Настройка окружения
├── 05_configure_service.sh    # Настройка systemd-сервиса
├── 06_validate_migration.sh   # Валидация миграции
├── 07_setup_monitoring.sh     # Настройка мониторинга
├── rollback.sh                # Откат миграции
├── backups/                   # Резервные копии
├── logs/                      # Логи миграции
└── temp/                      # Временные файлы
```

## Этапы миграции

### 1. Аудит исходного сервера
- Сбор информации о системе
- Проверка версий ПО
- Экспорт зависимостей
- Проверка структуры приложения
- Создание отчета

### 2. Подготовка целевого сервера
- Установка системных пакетов
- Настройка Python окружения
- Создание структуры директорий
- Проверка ресурсов

### 3. Резервное копирование и перенос
- Создание архива на исходном сервере
- Проверка целостности (checksums)
- Копирование на целевой сервер
- Распаковка и установка прав доступа
- Резервное копирование критичных файлов

### 4. Настройка окружения
- Создание виртуального окружения Python
- Установка зависимостей
- Проверка конфигурационных файлов
- Валидация импорта модулей

### 5. Настройка systemd-сервиса
- Создание конфигурации сервиса
- Настройка автозапуска
- Проверка конфигурации

### 6. Валидация миграции
- Проверка структуры файлов
- Проверка прав доступа
- Тестовый запуск приложения
- Проверка сетевого подключения
- Создание отчета о валидации

### 7. Настройка мониторинга
- Настройка logrotate
- Создание скриптов мониторинга
- Настройка cron
- Создание алиасов команд

## Запуск миграции

### Автоматический режим

```bash
cd /Users/edgark/auto/migration
./migrate.sh
```

### Интерактивный режим

```bash
./migrate.sh --interactive
```

### Тестовый режим

```bash
./migrate.sh --dry-run
```

### Пошаговый режим

```bash
./migrate.sh --step 1  # Выполнить только шаг 1
./migrate.sh --step 2  # Выполнить только шаг 2
# и т.д.
```

## После миграции

### 1. Остановка на исходном сервере

```bash
ssh aprel-server 'systemctl stop telegram-bot.service'
ssh aprel-server 'systemctl disable telegram-bot.service'
```

### 2. Запуск на целевом сервере

```bash
ssh auto-server 'systemctl start telegram-bot.service'
ssh auto-server 'systemctl status telegram-bot.service'
```

### 3. Мониторинг

```bash
# Просмотр логов
ssh auto-server 'journalctl -u telegram-bot.service -f'

# Статистика
ssh auto-server 'bot-stats'

# Проверка здоровья
ssh auto-server 'bot-health'
```

## Откат миграции

В случае проблем:

```bash
./rollback.sh
```

Скрипт автоматически:
1. Остановит сервис на новом сервере
2. Проверит исходный сервер
3. Запустит сервис на исходном сервере
4. Создаст отчет об откате

## Мониторинг и обслуживание

### Доступные алиасы

После настройки на целевом сервере доступны:

```bash
bot-status      # systemctl status telegram-bot.service
bot-start       # systemctl start telegram-bot.service
bot-stop        # systemctl stop telegram-bot.service
bot-restart     # systemctl restart telegram-bot.service
bot-logs        # journalctl -u telegram-bot.service -f
bot-logs-tail   # tail -f /var/log/telegram-bot.log
bot-stats       # Статистика работы
bot-health      # Проверка здоровья
```

### Автоматический мониторинг

- Проверка каждые 5 минут через cron
- Автоматический перезапуск при сбое
- Логирование в `/var/log/telegram-bot-healthcheck.log`

### Ротация логов

- Ежедневная ротация
- Хранение 30 дней для systemd логов
- Хранение 7 дней для логов приложения
- Максимальный размер 100MB

## Безопасность

### Защита конфиденциальных файлов

Все критичные файлы защищены правами доступа 600:
- .env файлы
- .session файлы
- .db файлы

### Резервные копии

Создаются резервные копии:
- Полный архив приложения
- Критичные файлы отдельно
- Контрольные суммы для проверки целостности

### SSH-ключи

Используются SSH-ключи для безопасной передачи данных между серверами.

## Устранение неполадок

### Проблемы с подключением

```bash
# Проверка SSH
ssh -i ~/.ssh/id_ed25519_aprel root@72.56.76.248 "echo OK"
ssh auto-server "echo OK"
```

### Проблемы с сервисом

```bash
# Проверка статуса
ssh auto-server 'systemctl status telegram-bot.service'

# Просмотр логов
ssh auto-server 'journalctl -u telegram-bot.service -n 100'

# Проверка конфигурации
ssh auto-server 'systemctl cat telegram-bot.service'
```

### Проблемы с Python

```bash
# Проверка виртуального окружения
ssh auto-server 'cd /root/auto && source venv/bin/activate && python --version'

# Проверка зависимостей
ssh auto-server 'cd /root/auto && source venv/bin/activate && pip list'
```

## Отчеты

Все скрипты создают подробные отчеты в директории `migration/backups/`:

- `audit_report_*.md` - Аудит исходного сервера
- `preparation_report_*.md` - Подготовка целевого сервера
- `transfer_report_*.md` - Перенос данных
- `environment_report_*.md` - Настройка окружения
- `service_report_*.md` - Настройка сервиса
- `validation_report_*.md` - Валидация миграции
- `monitoring_report_*.md` - Настройка мониторинга
- `rollback_report_*.md` - Откат (если выполнялся)

## Лучшие практики

### ✅ Рекомендуется

- Выполнять миграцию в период минимальной нагрузки
- Проверить все SSH-подключения перед началом
- Сохранить все отчеты и логи
- Мониторить работу в первые часы после миграции
- Сохранить резервную копию на исходном сервере минимум неделю

### ❌ Не рекомендуется

- Удалять данные на исходном сервере до подтверждения успешной миграции
- Пропускать этап валидации
- Запускать миграцию без резервных копий
- Изменять конфигурацию во время миграции

## Контрольный список

### Перед миграцией
- [ ] SSH-доступ к обоим серверам проверен
- [ ] Достаточно места на целевом сервере
- [ ] Создана резервная копия на исходном сервере
- [ ] Уведомлены заинтересованные стороны

### Во время миграции
- [ ] Все этапы выполнены последовательно
- [ ] Проверены отчеты каждого этапа
- [ ] Валидация пройдена успешно
- [ ] Настроен мониторинг

### После миграции
- [ ] Сервис запущен на новом сервере
- [ ] Бот отвечает в Telegram
- [ ] Автоматизация работает корректно
- [ ] Мониторинг настроен и работает
- [ ] Сервис на старом сервере остановлен
- [ ] Документация обновлена

## Поддержка

Логи миграции: `migration/logs/`
Отчеты: `migration/backups/`
Конфигурация: `migration/config.sh`

## Заключение

Система миграции разработана с учетом лучших практик DevOps:
- Автоматизация процессов
- Проверка целостности данных
- Детальное логирование
- План отката
- Мониторинг и алертинг

Следуйте инструкциям, и миграция пройдет гладко и безопасно!
