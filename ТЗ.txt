═══════════════════════════════════════════════════════════════════════════════
                         ТЕХНИЧЕСКОЕ ЗАДАНИЕ
      Миграция системы автоматизации Telegram-бота на новый сервер
═══════════════════════════════════════════════════════════════════════════════

Дата создания: 23 ноября 2024
Версия: 1.0


1. ОПИСАНИЕ ПРОЕКТА
───────────────────────────────────────────────────────────────────────────────

Система автоматизации для работы с Telegram-ботом, которая выполняет 
автоматическое нажатие на 3 inline-кнопки для бронирования рейсов в режиме 
реального времени.


2. ЦЕЛЬ МИГРАЦИИ
───────────────────────────────────────────────────────────────────────────────

Перенести полнофункциональную систему автоматизации с исходного сервера на 
целевой сервер с сохранением всей функциональности и настроек, обеспечив 
непрерывность работы сервиса.


3. СЕРВЕРНАЯ ИНФРАСТРУКТУРА
───────────────────────────────────────────────────────────────────────────────

3.1. Исходный сервер (источник миграции):
    • IP-адрес: 72.56.76.248
    • Подключение: ssh -i ~/.ssh/id_ed25519_aprel root@72.56.76.248
    • Алиас в SSH config: aprel-server
    • ОС: Ubuntu (версия уточняется при миграции)
    • Hostname: 5934165-yc246618

3.2. Целевой сервер (место назначения):
    • IP-адрес: 193.108.115.170
    • Подключение: ssh auto-server
    • Алиас в SSH config: auto-server
    • ОС: Ubuntu 24.04.3 LTS (Noble Numbat)
    • Hostname: 6090807-al360693
    • Kernel: 6.8.0-88-generic


4. ТЕКУЩАЯ КОНФИГУРАЦИЯ НА ИСХОДНОМ СЕРВЕРЕ
───────────────────────────────────────────────────────────────────────────────

4.1. Расположение приложения:
    Директория: /root/auto

4.2. Systemd-сервис:
    Имя: telegram-bot.service
    Статус: active (running)
    PID: 1050623
    Автозапуск: enabled
    Время работы: ~7+ часов непрерывно
    
4.3. Конфигурация systemd-сервиса:
    [Unit]
    Description=Telegram Bot Automation
    After=network.target

    [Service]
    Type=simple
    User=root
    WorkingDirectory=/root/auto
    ExecStart=/root/auto/venv/bin/python3 /root/auto/main.py
    Restart=always
    RestartSec=10
    StandardOutput=append:/var/log/telegram-bot.log
    StandardError=append:/var/log/telegram-bot.log

    [Install]
    WantedBy=multi-user.target

4.4. Основные файлы приложения:
    • main.py - точка входа приложения
    • bot_automation.py - основной модуль автоматизации (22,597 байт)
    • config.py - конфигурационные настройки (3,127 байт)
    • control_bot.py - панель управления (63,182 байт)
    • database.py - модуль работы с БД (9,979 байт)
    • session_manager.py - управление сессиями (17,380 байт)
    • models.py - модели данных (3,764 байт)
    • requirements.txt - зависимости Python
    
4.5. Директории:
    • venv/ - виртуальное окружение Python
    • modules/ - модули системы
    • sessions/ - файлы сессий Telegram
    • __pycache__/ - кэш Python

4.6. Конфигурационные файлы:
    • .env - переменные окружения (255 байт)
    • .env.2nd - конфиг для второй версии (359 байт)
    • .env.control_bot - конфиг панели управления (124 байт)
    • control_panel.db - база данных панели управления (36 KB)

4.7. Сессионные файлы Telegram:
    • bot_automation_session.session (28,672 байт)
    • telegram_session_2nd.session (28,672 байт)

4.8. Логи:
    • /var/log/telegram-bot.log - системные логи из systemd
    • bot_automation.log (3.75 MB) - логи приложения
    • bot_automation_2nd.log (6.58 MB)
    • control_bot.log (13.3 MB)


5. ЗАДАЧИ ДЛЯ ВЫПОЛНЕНИЯ
───────────────────────────────────────────────────────────────────────────────

5.1. Подготовительный этап:
    ☐ Провести аудит текущей конфигурации на исходном сервере
    ☐ Проверить версии установленного ПО (Python, pip, системные пакеты)
    ☐ Создать резервную копию всей директории /root/auto
    ☐ Экспортировать список Python-зависимостей (pip freeze)
    ☐ Зафиксировать текущие переменные окружения
    ☐ Проверить наличие внешних зависимостей (порты, API-ключи)

5.2. Остановка сервиса на исходном сервере:
    ☐ Остановить systemd-сервис: systemctl stop telegram-bot.service
    ☐ Отключить автозапуск: systemctl disable telegram-bot.service
    ☐ Создать финальный снапшот всех файлов
    ☐ Зафиксировать время остановки для отчетности

5.3. Перенос файлов на целевой сервер:
    ☐ Создать директорию /root/auto на целевом сервере
    ☐ Скопировать все файлы приложения через scp/rsync
    ☐ Скопировать конфигурационные файлы (.env, .env.*)
    ☐ Перенести файлы сессий Telegram (.session файлы)
    ☐ Скопировать базу данных control_panel.db
    ☐ Перенести исторические логи (опционально)
    ☐ Проверить целостность перенесенных файлов (checksums)

5.4. Настройка окружения на целевом сервере:
    ☐ Установить Python 3 (если отсутствует)
    ☐ Установить pip и virtualenv
    ☐ Установить системные зависимости (build-essential, libssl-dev и др.)
    ☐ Создать виртуальное окружение: python3 -m venv venv
    ☐ Активировать venv и установить зависимости: pip install -r requirements.txt
    ☐ Установить дополнительные пакеты (если требуются)

5.5. Проверка конфигурации:
    ☐ Проверить правильность путей в конфигурационных файлах
    ☐ Проверить наличие всех переменных окружения в .env файлах
    ☐ Проверить API-ключи и токены Telegram
    ☐ Проверить доступность Telegram API с нового сервера
    ☐ Провести тестовый запуск в ручном режиме
    ☐ Убедиться в корректной работе сессий Telegram

5.6. Создание и настройка systemd-сервиса:
    ☐ Создать файл /etc/systemd/system/telegram-bot.service
    ☐ Скопировать конфигурацию из исходного сервера
    ☐ Адаптировать пути под новый сервер (если требуется)
    ☐ Перезагрузить конфигурацию systemd: systemctl daemon-reload
    ☐ Включить автозапуск: systemctl enable telegram-bot.service
    ☐ Запустить сервис: systemctl start telegram-bot.service

5.7. Тестирование и валидация:
    ☐ Проверить статус сервиса: systemctl status telegram-bot.service
    ☐ Проверить логи: journalctl -u telegram-bot.service -f
    ☐ Убедиться, что бот откликается в Telegram
    ☐ Провести тест автоматизации нажатия на inline-кнопки
    ☐ Проверить бронирование тестового рейса
    ☐ Мониторить работу в течение 1-2 часов
    ☐ Проверить автоперезапуск сервиса после reboot

5.8. Настройка мониторинга и логирования:
    ☐ Настроить ротацию логов (logrotate)
    ☐ Настроить алерты при падении сервиса (опционально)
    ☐ Настроить мониторинг использования ресурсов
    ☐ Создать документацию по эксплуатации

5.9. Финализация миграции:
    ☐ Провести финальное тестирование всех функций
    ☐ Сравнить работу на старом и новом сервере
    ☐ Обновить документацию с новыми серверными данными
    ☐ Создать backup стратегию для нового сервера
    ☐ Архивировать данные на старом сервере
    ☐ Уведомить заинтересованные стороны о завершении миграции

5.10. Вывод из эксплуатации старого сервера (опционально):
    ☐ Сохранить полную резервную копию
    ☐ Удалить чувствительные данные (.env, API-ключи, сессии)
    ☐ Документировать процесс для будущих миграций


6. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ
───────────────────────────────────────────────────────────────────────────────

6.1. Программное обеспечение:
    • Python 3.x (версия совместимая с приложением)
    • pip (последняя версия)
    • virtualenv или venv
    • systemd (уже установлен в Ubuntu)

6.2. Сетевые требования:
    • Открытый доступ к Telegram API (порты 80, 443)
    • Стабильное интернет-соединение
    • Разрешение исходящих HTTPS соединений

6.3. Системные требования:
    • Минимум 512 MB RAM для приложения
    • Минимум 1 GB свободного места на диске
    • Процессор: 1 vCPU (минимум)

6.4. Безопасность:
    • Защита файлов .env (chmod 600)
    • Защита файлов .session (chmod 600)
    • Ограничение доступа к директории приложения
    • Использование SSH-ключей для доступа к серверу


7. КРИТЕРИИ УСПЕШНОЙ МИГРАЦИИ
───────────────────────────────────────────────────────────────────────────────

✓ Приложение запущено и работает на новом сервере
✓ Systemd-сервис настроен и работает стабильно
✓ Автоматизация нажатия кнопок функционирует корректно
✓ Бронирование рейсов выполняется успешно
✓ Telegram-сессии работают без переавторизации
✓ Логи пишутся корректно
✓ Сервис автоматически перезапускается при сбоях
✓ Сервис автоматически стартует после перезагрузки сервера
✓ Все конфигурационные файлы на месте
✓ Производительность соответствует или превышает исходную


8. РИСКИ И МЕРЫ МИТИГАЦИИ
───────────────────────────────────────────────────────────────────────────────

8.1. Риск: Потеря Telegram-сессий при переносе
    Митигация: Копировать .session файлы аккуратно, не изменяя содержимое

8.2. Риск: Несовместимость версий Python/библиотек
    Митигация: Зафиксировать версии через requirements.txt с точными версиями

8.3. Риск: Потеря данных при переносе
    Митигация: Создать несколько резервных копий перед началом миграции

8.4. Риск: Блокировка Telegram при смене IP-адреса
    Митигация: Использовать существующие сессии, избегать частых авторизаций

8.5. Риск: Downtime сервиса во время миграции
    Митигация: Провести миграцию в период минимальной нагрузки


9. ПЛАН ОТКАТА (ROLLBACK)
───────────────────────────────────────────────────────────────────────────────

В случае критических проблем на новом сервере:

1. Остановить сервис на новом сервере:
   systemctl stop telegram-bot.service

2. Вернуться на исходный сервер:
   ssh -i ~/.ssh/id_ed25519_aprel root@72.56.76.248

3. Запустить сервис на исходном сервере:
   systemctl start telegram-bot.service
   systemctl enable telegram-bot.service

4. Провести диагностику проблем на новом сервере

5. Повторить миграцию после устранения проблем


10. КОНТАКТЫ И ОТВЕТСТВЕННЫЕ ЛИЦА
───────────────────────────────────────────────────────────────────────────────

Исполнитель: [Указать ответственное лицо]
Дата начала: [Указать дату]
Планируемая дата завершения: [Указать дату]
Статус: Ожидает выполнения


11. ДОПОЛНИТЕЛЬНЫЕ КОМАНДЫ ДЛЯ МИГРАЦИИ
───────────────────────────────────────────────────────────────────────────────

# Создание архива на исходном сервере
cd /root && tar -czf auto_backup_$(date +%Y%m%d_%H%M%S).tar.gz auto/

# Копирование на целевой сервер
scp -i ~/.ssh/id_ed25519_aprel root@72.56.76.248:/root/auto_backup_*.tar.gz /tmp/
scp /tmp/auto_backup_*.tar.gz auto-server:/root/

# Распаковка на целевом сервере
ssh auto-server "cd /root && tar -xzf auto_backup_*.tar.gz"

# Проверка целостности
ssh auto-server "ls -la /root/auto/"

# Создание systemd сервиса
ssh auto-server "cat > /etc/systemd/system/telegram-bot.service << 'EOF'
[Unit]
Description=Telegram Bot Automation
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/auto
ExecStart=/root/auto/venv/bin/python3 /root/auto/main.py
Restart=always
RestartSec=10
StandardOutput=append:/var/log/telegram-bot.log
StandardError=append:/var/log/telegram-bot.log

[Install]
WantedBy=multi-user.target
EOF"


═══════════════════════════════════════════════════════════════════════════════
                              КОНЕЦ ДОКУМЕНТА
═══════════════════════════════════════════════════════════════════════════════
